# 🚀 CustomHttp

## 📘 项目简介

CustomHttp 是一个基于对 **Nginx 事件模块**与**HTTP 协议栈**深入学习后，从零构建的高性能、可扩展的 C++ 多线程高并发服务器框架。  
该项目以 **主从多进程架构 + epoll 事件驱动模型**为基础，配合线程池、连接池、时间队列等机制，具备完整的网络协议解析、会话管理、动态路由、日志系统、中间件支持等功能。

---

## 🛠️ 项目背景

- **目标**：理解并实践高性能服务器核心组件设计，打造可复用的 Web 服务基础框架。
- **设计理念**：参考 Nginx 架构，引入 epoll + 多进程 + 多线程模型，模块化设计，方便功能扩展与后续服务开发。

---

## 👤 个人职责

- ✳️ **架构搭建**：Master + Worker 多进程架构，每个 Worker 独立 epoll 实例、接收/发送队列。
- ✳️ **协议解析**：实现 Http 协议解析模块，支持请求行、请求头的动态解析。
- ✳️ **资源管理**：线程池管理线程生命周期，连接池管理套接字与 Http 会话绑定。
- ✳️ **路由系统**：实现支持多方法（GET/POST/PUT）的路由分发机制。
- ✳️ **会话管理**：开发健壮的会话机制，支持用户登录状态维护与超时处理。
- ✳️ **中间件机制**：开发中间件系统支持请求/响应预处理。
- ✳️ **性能测试**：使用 webbench 模拟 10,000 并发连接，完成压力测试与调优。

---

## 🔧 核心特性

- ✅ 高性能事件驱动：基于 epoll 的非阻塞 IO，极限压榨系统性能。
- ✅ 多进程协作：主进程监听连接，子进程处理业务，避免惊群。
- ✅ 高效线程池：预分配线程，避免频繁创建销毁，配合任务队列调度任务。
- ✅ 会话与状态管理：可维护登录状态，自动处理会话超时。
- ✅ 日志模块：支持多级别日志输出（DEBUG/INFO/WARN/ERROR）。
- ✅ 路由系统：基于 URI + 方法的灵活匹配机制，支持动态注册回调。
- ✅ 中间件机制：支持请求/响应生命周期内的功能注入。
- ✅ 守护进程模式：适合部署于生产环境，支持后台运行。

---

## ⚙️ 配置系统

- 配置文件 `config/nginx.conf` 包含以下设置：
  - `log_path`：日志输出路径
  - `worker_processes`：worker 子进程数量
  - `listen_port`：监听端口
  - `timeout`：连接超时时间
  - `thread_pool_size`：线程池大小
  - `daemon`：是否以守护进程运行

---

## 🧩 框架运行流程

1. 浏览器发起 HTTP 请求。
2. 主进程监听 socket 并通过 epoll 接收连接。
3. 调用 `ngx_event_accept` 接收连接，构造 Conn 实例。
4. 将请求加入 worker 的 `recv` 队列。
5. 工作线程解析请求（`parseRequest`），并绑定到 Conn。
6. 根据路由与回调函数分发逻辑。
7. 响应数据放入 `send` 队列，发送线程处理响应写回。
8. 支持半包、缓冲区不可写时挂起，等待 epoll 再次可写。

---

## 🧵 线程类型

- **线程池线程**：处理接收队列中的请求逻辑。
- **发送线程**：异步从发送队列中写回数据。
- **回收线程**：释放空闲连接资源，管理连接池。

---

## 📚 队列设计

- **recv 队列**：接收已连接 socket 的 HTTP 请求。
- **send 队列**：待发回客户端的响应报文。
- **回收队列**：需要清理/释放的连接。

---

## ⏰ 超时踢人机制

- 使用时间队列进行连接管理。
- `ServerTimerQueueMonitorThread` 监控连接超时时间。
- 若未活跃，自动加入回收队列释放资源。

---

## ⚡ 惊群处理机制

- 使用 `SO_REUSEPORT` 配置，让 OS 将连接平均分配至子进程，避免多个 worker 同时被唤醒争抢连接。

---

## 🔄 连接释放机制

- **主动回收**：连接超时后被踢出，加入回收队列释放。
- **客户端关闭**：EPOLLIN 检测到关闭信号，释放资源。
- **回收线程**：定期释放连接缓冲区、关闭 FD 并归还连接池。

---

## 📉 性能优化与难点

- ✅ **无锁队列替代加锁容器**，避免死锁并提升响应速度。
- ✅ **路由系统设计**灵活支持多种请求类型与路径匹配。
- ✅ 采用固定大小线程池避免频繁线程切换。
- ✅ 子进程间避免共享锁，提高并发执行效率。

---

## 🚫 待解决问题

- [ ] 是否支持热加载配置文件。
- [ ] 支持 HLS 视频在线播放卡顿调优。
- [ ] FFmpeg 转码后视频模糊，同时音视频不同步。
- [ ] 使用 sendfile 时传输大文件时的稳定性和断点续传支持。

---

## 🛑 退出机制

通过 `mynginx-quit.sh` 脚本可实现主进程优雅退出、关闭 socket、释放资源。

---
