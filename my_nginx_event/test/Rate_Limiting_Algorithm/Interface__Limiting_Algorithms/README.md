---

# ğŸ“š æ’æ‹”å¼ HTTP é™æµ Filter ç»„ä»¶ä½¿ç”¨è¯´æ˜

æœ¬ç»„ä»¶ä¸ºè‡ªå®šä¹‰ HTTP æ¡†æ¶æä¾› **æ’æ‹”å¼é™æµåŠŸèƒ½**ï¼Œæ”¯æŒä»¤ç‰Œæ¡¶é™æµã€æ¼æ–—é™æµç­‰ç®—æ³•ï¼Œç‹¬ç«‹äºä¸šåŠ¡é€»è¾‘ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- æ’æ‹”å¼æ³¨å†Œï¼Œä¸å…¥ä¾µ Controller
- æ”¯æŒå¤šç§é™æµç®—æ³•
- æ”¯æŒè‡ªå®šä¹‰é™æµç²’åº¦ï¼ˆå¦‚ IPã€ç”¨æˆ·IDï¼‰
- é«˜å¹¶å‘å®‰å…¨ï¼ˆé”ä¿æŠ¤ + é«˜æ•ˆå®ç°ï¼‰

---

## ğŸ› ï¸ ä½¿ç”¨æ­¥éª¤

### 1. åˆ›å»º FilterManager å®ä¾‹
åœ¨æœåŠ¡å™¨å¯åŠ¨ (`Server::run()`) åˆå§‹åŒ–é˜¶æ®µï¼Œåˆ›å»ºå…¨å±€å”¯ä¸€çš„ `FilterManager`ï¼š

```cpp
m_filterManager = std::make_shared<FilterManager>();
```

---

### 2. æ³¨å†Œé™æµ Filter
å°†é™æµè§„åˆ™ä»¥ç»„ä»¶å½¢å¼æ³¨å†Œè¿› `FilterManager`ã€‚

ç¤ºä¾‹ï¼ˆæ³¨å†Œä¸€ä¸ªä»¤ç‰Œæ¡¶é™æµå™¨ï¼‰ï¼š

```cpp
m_filterManager->addFilter(std::make_shared<RateLimiterFilter>(5 /*rate*/, 10 /*burst*/));
```

å«ä¹‰ï¼š
- `rate = 5` ï¼šå¹³å‡æ¯ç§’å…è®¸ 5 ä¸ªè¯·æ±‚é€šè¿‡
- `burst = 10`ï¼šå…è®¸çŸ­æ—¶é—´æœ€å¤šç§¯ç´¯ 10 ä¸ªä»¤ç‰Œï¼ˆå³ç¬æ—¶çˆ†å‘æœ€å¤š10ä¸ªè¯·æ±‚ï¼‰

å¯æ³¨å†Œå¤šä¸ªä¸åŒç±»å‹çš„ Filterï¼Œå®ç°æ›´å¤æ‚çš„é“¾å¼æ‹¦æˆªã€‚

---

### 3. åœ¨ HTTP è¯·æ±‚å…¥å£ç»Ÿä¸€æ‰§è¡Œ Filter é“¾
åœ¨æ”¶åˆ° HTTP è¯·æ±‚æ—¶ï¼Œæ‰§è¡Œæ‰€æœ‰ Filterã€‚  
å¦‚æœä»»ä½•ä¸€ä¸ª Filter æ‹¦æˆªè¯·æ±‚ï¼Œç«‹å³è¿”å›é”™è¯¯å“åº”ï¼›å¦‚æœå…¨éƒ¨é€šè¿‡ï¼Œç»§ç»­æ­£å¸¸è·¯ç”±å¤„ç†ã€‚

ç¤ºä¾‹ï¼š

```cpp
onHttpRequest = [this](const HttpRequestPtr& req) {
    m_filterManager->doFilters(req,
        [](HttpResponsePtr resp) {
            // Filteræ‹¦æˆªï¼Œç›´æ¥è¿”å›å“åº”
            sendHttpResponse(resp);
        },
        [req]() {
            // æ‰€æœ‰Filteré€šè¿‡ï¼Œæ­£å¸¸åˆ†å‘è¯·æ±‚
            dispatchRequest(req);
        }
    );
};
```

---

## ğŸ“„ å®Œæ•´ä»£ç ç¤ºä¾‹

```cpp
void Server::run() {
    // 1. åˆ›å»º FilterManager
    m_filterManager = std::make_shared<FilterManager>();

    // 2. æ³¨å†Œ RateLimiterFilter (ä»¤ç‰Œæ¡¶é™æµ)
    m_filterManager->addFilter(std::make_shared<RateLimiterFilter>(5, 10));

    // 3. åœ¨æ”¶åˆ° HTTP è¯·æ±‚æ—¶ç»Ÿä¸€æ‰§è¡Œ Filter é“¾
    onHttpRequest = [this](const HttpRequestPtr& req) {
        m_filterManager->doFilters(req,
            [](HttpResponsePtr resp) {
                sendHttpResponse(resp); // è¢«é™æµç›´æ¥è¿”å›
            },
            [req]() {
                dispatchRequest(req);   // æ­£å¸¸å¤„ç†ä¸šåŠ¡
            }
        );
    };
}
```

---

## ğŸš¦ Filterå¤„ç†æµç¨‹ç¤ºæ„å›¾

```
Httpè¯·æ±‚è¿›å…¥
    â†“
FilterManager::doFilters()
    â†“
é¡ºåºæ‰§è¡Œæ¯ä¸ªFilter
    â†“
    â”œâ”€â”€ è‹¥æŸä¸ªFilteræ‹’ç» â†’ ç«‹å³è¿”å›é”™è¯¯å“åº”
    â””â”€â”€ æ‰€æœ‰Filteré€šè¿‡ â†’ æ­£å¸¸dispatchåˆ°ä¸šåŠ¡Handler
```

---

## ğŸ“ˆ åç»­æ‰©å±•å»ºè®®

- æ”¯æŒæŒ‰ä¸åŒ **IP / ç”¨æˆ·ID / APIè·¯å¾„** å•ç‹¬é™æµ
- æ”¯æŒé™æµé…ç½® **çƒ­æ›´æ–°**
- æ”¯æŒä¸åŒé™æµç®—æ³•ï¼ˆå¦‚æ¼æ–—é™æµã€æ»‘åŠ¨çª—å£é™æµï¼‰
- æ”¯æŒæ ¹æ®è¯·æ±‚Header / Tokençµæ´»é€‰æ‹©é™æµç»´åº¦
- é€šè¿‡ç­–ç•¥æ¨¡å¼ (`IRateLimiter`) æ”¯æŒåŠ¨æ€åˆ‡æ¢é™æµç­–ç•¥

---

# âœ… å°ç»“

| ç‰¹æ€§            | è¯´æ˜                                      |
|:----------------|:------------------------------------------|
| æ’æ‹”å¼          | éšæ—¶æ·»åŠ æˆ–ç§»é™¤Filter |
| é«˜å¹¶å‘          | å…¨ç¨‹çº¿ç¨‹å®‰å…¨ï¼Œæ”¯æŒé«˜å¹¶å‘è®¿é—® |
| çµæ´»æ‰©å±•        | æ”¯æŒå¤šç§é™æµç­–ç•¥åˆ‡æ¢ |
| æ— ä¾µå…¥          | ä¸å½±å“ç°æœ‰ Controller å±‚ä»£ç é€»è¾‘ |

---
